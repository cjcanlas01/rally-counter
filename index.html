<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rally Counter</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z"
      crossorigin="anonymous"
    />
  </head>

  <body style="margin: 10px 20px 0px 20px">
    <h1>Temple of Mother</h1>
    <div class="section">
      <table class="table">
        <thead>
          <tr>
            <th scope="col">Rally Leaders</th>
            <th scope="col">ETA</th>
            <th scope="col">Marching Speed</th>
            <th scope="col">Travelling Time</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button type="button" class="btn btn-primary" id="set">SET</button>
      <button type="button" class="btn btn-primary" id="start">START</button>
    </div>
  </body>
  <script
    src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous"
  ></script>
  <script
    src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"
  ></script>
  <script
    src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
    integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
    crossorigin="anonymous"
  ></script>
  <script>
    // Rally leader info
    const rallyLeader = [
      {
        name: "Vilmarys",
        marching_speed: "172",
        travelling_time: "62",
      },
      {
        name: "Oni Fae",
        marching_speed: "173",
        travelling_time: "62",
      },
      {
        name: "Gone Mad",
        marching_speed: "188",
        travelling_time: "57",
      },
      {
        name: "TEALC",
        marching_speed: "166",
        travelling_time: "64",
      },
      {
        name: "Apophiz",
        marching_speed: "169.5",
        travelling_time: "63",
      },
      {
        name: "Epix",
        marching_speed: "158",
        travelling_time: "68",
      },
      {
        name: "Chet Manley",
        marching_speed: "169",
        travelling_time: "63",
      },
      {
        name: "Rouge Jake",
        marching_speed: "175",
        travelling_time: "61",
      },
      {
        name: "Demon Cat",
        marching_speed: "159",
        travelling_time: "67",
      },
      {
        name: "Centurion",
        marching_speed: "172",
        travelling_time: "62",
      },
    ];
    const GRACE_PERIOD = 5;
    let INTERVAL_ID;

    // Compare function
    const compare = (a, b) => {
      if (parseInt(a.travelling_time) < parseInt(b.travelling_time)) {
        return 1;
      }
      if (parseInt(a.travelling_time) > parseInt(b.travelling_time)) {
        return -1;
      }
      return 0;
    };

    const getETA = (rallyLeadRecord, index, GRACE_PERIOD) => {
      if (index == 0) {
        return GRACE_PERIOD;
      } else {
        return (
          rallyLeadRecord[0]["travelling_time"] -
          rallyLeadRecord[index]["travelling_time"] +
          GRACE_PERIOD
        );
      }
    };

    // Load all rally leads on rows
    $(document).ready(function () {
      // Sort first rally leader record from slowest to fastest
      rallyLeader.sort(compare);
      // Display rally leader records on table
      rallyLeader.forEach((value, index) => {
        $("tbody").append(`
            <tr>
              <td scope="row">(${index + 1}) ${value.name}</td>
              <td>0</td>
              <td>${value.marching_speed}%</td>
              <td>${value.travelling_time}s</td>
            </tr>
          `);
      });
    });

    // Reset
    $("#set").click(function () {
      $("tbody tr").css({
        color: "black",
        "font-weight": "normal",
      });
      setRallyTime();
      clearInterval(INTERVAL_ID);
    });

    const setRallyTime = () => {
      $("tbody tr").each((index, el) => {
        $(el).find("td").eq(1).html(getETA(rallyLeader, index, GRACE_PERIOD));
      });
    };

    $("#start").click(function () {
      rallyLeader.map((value, index) => {
        value["eta"] = getETA(rallyLeader, index, GRACE_PERIOD);
        return value;
      });

      INTERVAL_ID = setInterval(function () {
        rallyLeader.map((value, index) => {
          value["eta"] -= 1;
          return value;
        });

        $("tbody tr").each((index, el) => {
          if (rallyLeader[index]["eta"] > 0) {
            $(el).find("td").eq(1).html(rallyLeader[index]["eta"]);
          } else {
            $(el).css({
              color: "green",
              "font-weight": "900",
            });
            $(el).find("td").eq(1).html("GO!");
          }
        });
      }, 1000);
    });
  </script>
</html>
